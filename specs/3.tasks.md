# Development Tasks for aki-mline

This checklist is generated from the design document (`specs/2.design.md`) and reflects the features already implemented in the source code.

### Architecture

- [x] Structure the project into a binary crate (`aki-mline`) and a library crate (`libaki_mline`).

### `main.rs` (Binary Crate)

- [x] Implement the main application entry point.
- [x] Gather command-line arguments from `std::env::args`.
- [x] Set up I/O streams using `runnel::RunnelIoeBuilder`.
- [x] Call the `libaki_mline::execute` function with processed arguments.
- [x] Handle top-level errors from the library call and set the process exit code accordingly.

### `lib.rs` (Library Crate)

- [x] Define the primary public API function, `execute()`.
- [x] Create an `execute_env()` function to separate environment configuration from the main call.
- [x] Orchestrate the application flow: parse config -> run core logic.
- [x] Implement early exit for `--help` and `--version` flags.

### `conf` Module (Configuration)

- [x] Create a `CmdOptConf` struct to hold all command-line option values.
- [x] Create an `EnvConf` struct to hold settings from environment variables.
- [x] Implement the command-line argument parser in `conf::parse` using `flood_tide`.
- [x] Define all command-line options (`-e`, `-s`, `-i`, `--color`, etc.).
- [x] Implement logic to read `AKI_MLINE_COLOR_SEQ_ST` and `AKI_MLINE_COLOR_SEQ_ED` environment variables.
- [x] Implement the `--color=auto` behavior by checking if `stdout` is a TTY with the `atty` crate.

### `run` Module (Core Logic)

- [x] Implement the main `run()` function to orchestrate the filtering process.
- [x] Pre-compile regex patterns from the configuration for improved performance.
- [x] Implement the `do_match_proc()` function to loop through input lines.
- [x] Implement line matching for both regex (`regex` crate) and simple strings (`naive_opt` crate).
- [x] Implement inverse matching logic (`-i` flag).
- [x] Implement the `make_line_color_mark()` function to create a boolean mask of matched characters.
- [x] Implement the `make_out_s()` function to construct the final output string with ANSI color codes based on the boolean mask.
- [x] Implement graceful handling of `BrokenPipe` errors.

### `util` Module (Utilities)

- [x] Create custom, type-safe structs and enums for command-line option parameters (`OptColorWhen`, `OptAroundNum`, `OptUcXParam`).
- [x] Implement the `FromStr` trait for all custom option types to integrate with `flood_tide`.
- [x] Define and implement the `BrokenPipeError` trait for clean error handling in the `run` module.

### General

- [x] Add all necessary external dependencies (`anyhow`, `flood_tide`, `regex`, `runnel`, `atty`, `naive_opt`) to `Cargo.toml`.
